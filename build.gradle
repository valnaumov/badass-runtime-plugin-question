/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * To learn more about Gradle by exploring our Samples at https://docs.gradle.org/8.5/samples
 * This project uses @Incubating APIs which are subject to change.
 */
plugins {
    id 'java'
    id 'application'
    id 'org.beryx.runtime' version '1.12.7'
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

application {
    mainClass = 'my.ConsoleApp'
}

runtime {
    launcher {
        windowsScriptTemplate = file('jpackage\\windowsScriptTemplate.txt')
    }
    jpackage {
        imageOptions  << '--win-console'
        installerOptions << '--verbose'
    }
}

// Starting with Gradle 8.4, the clean task failed with an IOException when deleting a read-only file (Gradle 8.3 and earlier handled it OK).
// The EXE file is the only read-only file that is built, so the workaround is to remove its read-only attribute if the file exists.
tasks.register('changeJpackageExeAttributes', Exec) {
    def imageName = runtime.jpackageData.get().getImageNameOrDefault()

    def exeFile = file("build/jpackage/${imageName}/${imageName}.exe")
    onlyIf { exeFile.exists() }
    commandLine 'cmd', '/c', "attrib -r \"$exeFile\""
}
clean.dependsOn(changeJpackageExeAttributes)
jpackageImage.dependsOn(changeJpackageExeAttributes)